#!/bin/sh
#
# LightZone startscript
#
echo Starting LightZone version 4.1.5 ...
echo with options : ${@}
java -version

arch=`getconf LONG_BIT`
PLATFORM=`uname`
if [ "${PLATFORM}" = "Linux" ]; then
  totalmem=`cat /proc/meminfo | grep 'MemTotal: ' | sed -r 's/.* ([0-9]+) .*/\1/'`
  usrdir=/usr
elif [ "${PLATFORM}" = "SunOS" ]; then
  totalmem=`prtconf | grep 'Memory size:' | sed -r 's/.* ([0-9]+) .*/\1/'`
  totalmem=`expr $totalmem \* 1024`
  usrdir=/usr
elif [ "${PLATFORM}" = "FreeBSD" ]; then
  totalmem=`sysctl -n hw.physmem`
  totalmem=`expr $totalmem / 1024`
  usrdir=%%LOCALBASE%%
fi

if [ -d ${usrdir}/share/java/lightzone ]; then
  pkgjavadir=${usrdir}/share/java/lightzone
else
  # Gentoo
  pkgjavadir=${usrdir}/share/lightzone/lib
fi

if [ -d ${usrdir}/libexec/lightzone ]; then
  pkglibexecdir=${usrdir}/libexec/lightzone
elif [ -d ${usrdir}/lib64/lightzone ]; then
  pkglibexecdir=${usrdir}/lib64/lightzone
else
  pkglibexecdir=${usrdir}/lib/lightzone
fi

if [ -d ${usrdir}/share/java/ ]; then
  if [ -d ${usrdir}/share/java/javahelp ]; then
    if  [ -d ${usrdir}/share/java/javahelp/lib ]; then
      jhpath=${usrdir}/share/java/javahelp/lib/jh.jar
    else
      jhpath=${usrdir}/share/java/javahelp/jh.jar
    fi
  else
   jhpath=${usrdir}/share/java/jh.jar
  fi
elif [ -d ${usrdir}/local/share/java/classes ]; then
   jhpath=${usrdir}/local/share/java/classes/jh.jar
fi

if [ -z "$jhpath" ]; then
  echo "jh.jar was not found."
elif [ ! -e $jhpath ]; then
  echo "jh.jar was not found in ${jhpath}"
fi

if [ $totalmem -ge 1048576 ]; then
  maxmem=$(( $totalmem / 2 ))
  # on 32-bit architectures there is ~2GB limit for maximum Java heap size
  if [ $arch = "32" -a $totalmem -ge 4194304 ]; then
    maxmem=2097152
  fi
else
    maxmem=524288
fi

# IFS should be \n to handle filenames that include space.
IFS="
"
file=""
for i in "$@"; do
  if [ -f $i ] ; then
    file=$(cd $(dirname $i) && pwd)/$(basename $i)
    break
  fi
done

(cd $pkgjavadir && LD_LIBRARY_PATH=$pkglibexecdir exec java -Xmx${maxmem}k -Djava.library.path=$pkglibexecdir -Dfile.encoding=UTF8 -classpath ".:${pkgjavadir}/*:${jhpath}" com.lightcrafts.platform.linux.LinuxLauncher ${file} ${@} )
